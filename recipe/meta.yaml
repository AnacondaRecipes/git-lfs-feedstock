{% set goname = "github.com/git-lfs/git-lfs" %}
{% set version = "3.6.1" %}

{% set name = goname.split('/')[-1] %}
{% set pkg_src = ('src/'+goname).replace("/", os.sep) %}

package:
  name: {{ name|lower }}
  version: {{ version|replace("-", "_") }}

source:
  - folder: {{ pkg_src }}
    url: https://{{ goname }}/archive/v{{ version }}.tar.gz
    sha256: 062603dbef8f221d867e542314e9a6ea1970cae536b4495de2e915529b0fef8e

build:
  number: 0
  script:
    - set -x                                                           # [unix]
    - cd {{ pkg_src }}
    - go mod tidy                                                      # Ensure dependencies are properly configured
    - go generate ./commands                                           # [not (osx and arm64)]
    - GOARCH=amd64 go generate ./commands                              # [osx and arm64]
    - go build -v -ldflags "-w -s" -o $PREFIX/bin/git-lfs              # [build_platform != target_platform]
    - go install -v -ldflags "-w -s" .                                 # [build_platform == target_platform and not win]
    - go build -v -ldflags "-w -s" -o %PREFIX%\Library\bin\git-lfs.exe # [win]
    - go-licenses save . --save_path={{ SRC_DIR }}/license_files || true
    # Clear cache to avoid excessive file not removable warnings
    - chmod -R u+w $(go env GOPATH) && rm -r $(go env GOPATH)          # [unix]

requirements:
  build:
    - {{ compiler('go') }}
    - git
  host:
    - go
  run:
    - git

test:
  commands:
    - shasum -a 256 $(which git-lfs)                # [osx]
    - git-lfs --help

about:
  home: https://git-lfs.com/
  license: MIT
  license_family: MIT
  license_file: {{ environ["RECIPE_DIR"] }}/LICENSE.md
  summary: Git extension for versioning large files
  description: |
    Git LFS is a command line extension and specification for managing large files with Git.
  dev_url: https://github.com/git-lfs/git-lfs
  doc_url: https://github.com/git-lfs/git-lfs/tree/main/docs

extra:
  recipe-maintainers:
    - dfroger
    - willirath
    - dbast
